name: Build Linux

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-24.04
            qt_arch: linux_gcc_64
          - arch: arm64
            runner: ubuntu-24.04-arm
            qt_arch: linux_gcc_arm64

    runs-on: ${{ matrix.runner }}
    name: Linux ${{ matrix.arch }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt 6.7
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          modules: 'qtmultimedia'
          arch: ${{ matrix.qt_arch }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake \
            libgl1-mesa-dev libglu1-mesa-dev \
            libxcb-cursor0 libxcb-cursor-dev \
            libxkbcommon-dev libxkbcommon-x11-0 \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
            libpulse-dev libasound2-dev \
            libfuse2t64 \
            ffmpeg

      - name: Build
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_PREFIX_PATH="${QT_ROOT_DIR}"
          make -j$(nproc)

      - name: Create AppImage
        run: |
          cd build
          DESTDIR=../AppDir make install
          cd ..

          if [ "${{ matrix.arch }}" = "arm64" ]; then
            DEPLOY_ARCH="aarch64"
          else
            DEPLOY_ARCH="x86_64"
          fi

          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-${DEPLOY_ARCH}.AppImage"
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-${DEPLOY_ARCH}.AppImage"
          chmod +x *.AppImage

          export APPIMAGE_EXTRACT_AND_RUN=1
          export QMAKE="${QT_ROOT_DIR}/bin/qmake"
          export LD_LIBRARY_PATH="${QT_ROOT_DIR}/lib:${LD_LIBRARY_PATH}"
          export PATH="${QT_ROOT_DIR}/bin:${PATH}"

          echo "QT_ROOT_DIR=${QT_ROOT_DIR}"
          echo "QMAKE=${QMAKE}"
          ls -la "${QMAKE}"

          rm -f "${QT_ROOT_DIR}/plugins/multimedia/libffmpegmediaplugin.so"

          ./linuxdeploy-${DEPLOY_ARCH}.AppImage \
            --appdir AppDir \
            --plugin qt \
            --desktop-file AppDir/usr/share/applications/ffab.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/512x512/apps/ffab.png \
            --output appimage

          mv FFAB-*.AppImage FFAB-${{ github.ref_name }}-linux-${{ matrix.arch }}.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: ffab-linux-${{ matrix.arch }}
          path: 'FFAB-*.AppImage'

  release:
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ffab-linux-x86_64/*.AppImage
            ffab-linux-arm64/*.AppImage
          draft: true
